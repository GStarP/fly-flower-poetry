# 飞花令游戏模块化设计方案

## 1. 需求分析

### 1.1 功能需求

- **游戏初始化**：玩家选择一个汉字作为限定字进行游戏
- **机器人对战**：系统能够输出包含限定字的诗句
- **玩家输入**：玩家能够输入包含限定字的诗句
- **输入验证**：系统验证玩家输入的诗句是否有效（包含限定字、是否重复）
- **胜负判定**：系统能够判断游戏胜负
- **学习功能**：玩家失败后，系统展示三条符合条件的诗句供学习
- **游戏重启**：玩家可以重新开始游戏

### 1.2 非功能需求

- **部署方式**：纯前端实现，无需服务器
- **性能要求**：高效的诗句查询性能
- **用户体验**：良好的用户体验和界面设计
- **设备适配**：响应式设计，适配不同设备

## 2. 技术选型

| 技术领域       | 选型方案             | 说明                              |
| -------------- | -------------------- | --------------------------------- |
| **前端框架**   | React + TypeScript   | 提供类型安全和组件化开发          |
| **构建工具**   | Vite                 | 快速的开发构建工具                |
| **数据存储**   | SQLite (SQL.js)      | 通过 SQL.js 在浏览器中使用 SQLite |
| **UI 组件库**  | 自定义组件库         | 基于 antd 封装符合古风主题的组件  |
| **状态管理**   | useReducer + Context | React 原生状态管理方案            |
| **包管理工具** | pnpm                 | 快速、节省磁盘空间的包管理工具    |

## 3. 模块划分

根据功能内聚性和耦合性原则，将系统划分为以下模块：

### 3.1 核心业务模块

#### 3.1.1 数据管理模块（DataModule）

**功能描述**：负责加载、管理和查询诗词数据库

**主要职责**：

- 初始化并加载 SQLite 数据库
- 提供诗句查询接口
- 提供诗词详细信息查询接口

**数据库表结构**：

```sql
-- 诗词表
CREATE TABLE poetry (
    poetry_id INTEGER PRIMARY KEY AUTOINCREMENT,
    author TEXT NOT NULL,
    title TEXT NOT NULL
);

-- 句子表
CREATE TABLE sentence (
    sentence_id INTEGER PRIMARY KEY AUTOINCREMENT,
    poetry_id INTEGER NOT NULL,
    poetry_index INTEGER NOT NULL,
    content TEXT NOT NULL,
    FOREIGN KEY (poetry_id) REFERENCES poetry (poetry_id)
);

-- 索引
CREATE INDEX idx_sentence_id ON sentence (sentence_id);
CREATE INDEX idx_poetry_id ON sentence (poetry_id);
```

**接口设计**：

```typescript
interface DataModule {
  // 初始化数据库
  initDatabase(): Promise<boolean>;

  // 根据部分内容匹配诗句
  queryPoetrySentences(
    partialContent: string,
    excludeIds?: number[],
    limit?: number
  ): Promise<Sentence[]>;

  // 根据诗词ID获取诗词详细信息
  getPoetryById(poetryId: number): Promise<Poetry>;
}

interface Sentence {
  id: number;
  content: string;
  poetryId: number;
  poetryIndex: number;
}

interface Poetry {
  id: number;
  author: string;
  title: string;
  paragraphs: string[]; // 包含诗词的所有句子内容
}
```

#### 3.1.2 游戏逻辑模块（GameModule）

**功能描述**：负责游戏的核心逻辑，包括游戏状态管理、规则判定等

**主要职责**：

- 管理游戏状态（准备、进行中、结束）
- 实现游戏规则逻辑
- 控制游戏流程
- 计时管理

**接口设计**：

```typescript
interface GameModule {
  // 开始新游戏
  startNewGame(limitChar: string): void;

  // 机器人回合
  robotTurn(): Promise<GameTurnResult>;

  // 玩家回合
  playerTurn(sentence: string): Promise<GameTurnResult>;

  // 结束游戏
  endGame(): GameResult;

  // 获取当前游戏状态
  getGameState(): GameState;

  // 重置游戏
  resetGame(): void;
}

interface GameState {
  status: "ready" | "playing" | "ended";
  limitChar: string;
  currentTurn: "player" | "robot";
  usedSentences: Sentence[];
  remainingTime?: number; // 玩家剩余时间（秒）
  result?: GameResult;
}

interface GameTurnResult {
  success: boolean;
  sentence?: Sentence;
  message?: string;
  gameOver?: boolean;
}

interface GameResult {
  winner: "player" | "robot";
  reason: string;
  recommendedSentences?: Sentence[];
}
```

### 3.2 用户界面模块

#### 3.2.1 UI 组件模块（ComponentsModule）

**功能描述**：提供游戏所需的各种 UI 组件

**设计原则**：

- 组件化设计，提高复用性
- 符合古风主题的视觉风格
- 响应式布局，适配不同设备

#### 3.2.2 页面模块（PagesModule）

**功能描述**：组织各个页面的结构和布局

**设计原则**：

- 清晰的页面层次结构
- 流畅的页面间导航
- 一致的用户交互体验

> **注**：具体的组件设计和页面布局将在开发阶段详细讨论

## 4. 模块交互设计

### 4.1 数据流向

#### 4.1.1 用户交互流

```
用户 → UI组件 → 游戏逻辑模块 → 数据管理模块 → 游戏逻辑模块 → UI组件 → 用户
```

#### 4.1.2 游戏初始化流

```
应用启动 → 数据管理模块(加载数据库) → 游戏逻辑模块(初始化) → UI组件(渲染界面)
```

#### 4.1.3 游戏进行流

```
玩家输入 → 游戏逻辑模块(验证) → 数据管理模块(查询) → 游戏逻辑模块(更新状态) → UI组件(更新显示)
```

### 4.2 状态管理

采用 **React Context API** 和 **useReducer** 管理全局状态：

```typescript
// 全局状态结构
interface AppState {
  game: GameState;
  settings: {
    difficulty: "easy" | "medium" | "hard";
    timeLimit: number; // 秒
  };
  database: {
    loaded: boolean;
    error?: string;
  };
}

// 主要 Action 类型
type AppAction =
  | { type: "START_GAME"; payload: { limitChar: string } }
  | { type: "PLAYER_TURN"; payload: { sentence: string } }
  | { type: "ROBOT_TURN" }
  | { type: "END_GAME" }
  | { type: "RESET_GAME" }
  | { type: "UPDATE_SETTINGS"; payload: Partial<AppState["settings"]> }
  | { type: "DATABASE_LOADED" }
  | { type: "DATABASE_ERROR"; payload: { error: string } };
```

## 5. 文件结构设计

```
src/
├── assets/            # 静态资源
├── components/        # 通用 UI 组件（具体页面结构待开发时确定）
├── modules/           # 核心模块
│   ├── data/  # 数据管理模块
│   └── game/  # 游戏逻辑模块
├── pages/             # 页面组件（具体页面结构待开发时确定）
├── utils/             # 通用工具函数
├── App.tsx            # 应用入口组件
├── main.tsx           # 应用入口文件
└── types.ts           # 类型定义
```

## 6. 设计总结

### 6.1 设计优势

本设计方案基于模块化思想，具有以下优势：

- **职责明确**：将系统划分为数据管理、游戏逻辑、UI 组件等核心模块，每个模块职责清晰
- **接口规范**：模块间通过定义良好的接口进行通信，降低模块间的耦合度
- **易于维护**：高内聚低耦合的设计原则，便于后续维护和功能扩展
- **技术合理**：采用 React 生态的成熟技术栈，保证开发效率和代码质量

### 6.2 实现要点

- **性能优化**：重点关注诗句查询性能，确保游戏体验流畅
- **用户体验**：注重界面设计和交互逻辑，提供良好的用户体验
- **扩展性**：预留难度调整等扩展接口，支持未来功能增强
